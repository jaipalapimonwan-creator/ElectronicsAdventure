<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผจญภัยในโลกอิเล็กทรอนิกส์ - Firebase Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --pcb-green: #064e3b;
            --pcb-line: #059669;
            --neon-blue: #00f2ff;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
            margin: 0;
            overflow: hidden;
        }

        .font-cyber { font-family: 'Orbitron', sans-serif; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 242, 255, 0.3);
            border-radius: 24px;
        }

        .btn-cyber {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
            transition: all 0.3s ease;
        }

        .btn-cyber:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(0, 242, 255, 0.6);
        }

        .level-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .level-card:not(.locked):hover {
            border-color: var(--neon-blue);
            transform: scale(1.05);
            background: rgba(14, 165, 233, 0.1);
        }
        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .tab-btn.active {
            color: var(--neon-blue);
            border-bottom: 2px solid var(--neon-blue);
        }

        /* Profile Style */
        .profile-badge {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(0, 242, 255, 0.5);
            border-top: none;
            border-radius: 0 0 16px 16px;
        }
    </style>
</head>
<body>

    <div id="game-container" class="relative w-screen h-screen flex justify-center items-center overflow-hidden">
        <!-- พื้นหลังตกแต่ง -->
        <div class="absolute inset-0 opacity-10 pointer-events-none" 
             style="background-image: radial-gradient(var(--pcb-line) 1px, transparent 1px); background-size: 40px 40px;"></div>

        <!-- แผงโปรไฟล์ผู้ใช้งาน (User Profile) -->
        <div id="user-profile" class="absolute top-0 right-10 z-[60] hidden">
            <div class="profile-badge px-6 py-3 flex items-center gap-4 shadow-[0_0_20px_rgba(0,242,255,0.2)]">
                <div class="text-right border-r border-slate-700 pr-4">
                    <div id="profile-name" class="text-sm font-semibold text-white leading-tight">User Name</div>
                    <div id="profile-sid" class="text-[10px] font-cyber text-cyan-400 tracking-wider leading-tight">66XXXXXX</div>
                </div>
                <button onclick="location.reload()" class="p-2 hover:bg-rose-500/20 rounded-full transition-colors group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 group-hover:text-rose-500" fill="none" viewBox="24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- หน้าจอเข้าสู่ระบบ (Authentication View) -->
        <div id="auth-view" class="z-50 glass-panel p-8 w-full max-w-md mx-4">
            <h1 class="text-3xl font-cyber text-center mb-6 text-cyan-400 uppercase tracking-tighter">System Access</h1>
            
            <div class="flex mb-6 border-b border-slate-700">
                <button id="tab-student" class="tab-btn active flex-1 py-2 font-cyber text-xs">STUDENT</button>
                <button id="tab-teacher" class="tab-btn flex-1 py-2 font-cyber text-xs text-slate-500">TEACHER</button>
            </div>

            <div id="student-form" class="space-y-4">
                <input type="text" id="input-name" placeholder="ชื่อ-นามสกุล" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl focus:border-cyan-500 outline-none">
                <input type="text" id="input-sid" placeholder="รหัสนักศึกษา" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl focus:border-cyan-500 outline-none">
                <button id="login-student-btn" class="btn-cyber w-full py-3 rounded-xl font-cyber font-bold">INITIALIZE SESSION</button>
            </div>

            <div id="teacher-form" class="space-y-4 hidden">
                <input type="password" id="input-pass" placeholder="Teacher Secret Key" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl focus:border-cyan-500 outline-none">
                <button id="teacher-login-btn" class="btn-cyber w-full py-3 rounded-xl font-cyber font-bold">ACCESS DASHBOARD</button>
            </div>
            
            <p id="auth-status" class="mt-4 text-center text-[10px] text-slate-500 font-cyber uppercase tracking-widest">Connecting to network...</p>
        </div>

        <!-- แผงควบคุมสำหรับครู (Teacher Dashboard) -->
        <div id="teacher-view" class="z-50 glass-panel p-8 w-full max-w-4xl mx-4 hidden max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-cyber text-cyan-400 uppercase">Class Overview</h2>
                <button onclick="location.reload()" class="text-xs text-slate-400 hover:text-white uppercase">Logout</button>
            </div>
            <table class="w-full text-left text-sm">
                <thead class="text-cyan-500 font-cyber text-[10px] uppercase border-b border-slate-800">
                    <tr>
                        <th class="p-3">ID</th>
                        <th class="p-3">Name</th>
                        <th class="p-3 text-center">Progress</th>
                        <th class="p-3 text-center">High Score</th>
                    </tr>
                </thead>
                <tbody id="teacher-table-body"></tbody>
            </table>
        </div>

        <!-- เมนูหลัก (Main Menu) -->
        <div id="main-menu" class="z-50 hidden text-center">
            <h1 class="text-6xl font-cyber font-bold mb-8 text-white uppercase tracking-tighter">Electronics<br><span class="text-cyan-400">Adventure</span></h1>
            <button id="play-btn" class="btn-cyber px-16 py-4 rounded-full font-cyber text-xl font-bold uppercase tracking-widest">Start Game</button>
            <p id="player-welcome" class="mt-6 text-slate-400 font-cyber text-xs uppercase tracking-widest"></p>
        </div>

        <!-- เลือกด่าน (Level Selection) -->
        <div id="level-selection" class="z-50 hidden glass-panel p-8 w-full max-w-4xl mx-4">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-cyber text-white uppercase">Select Node</h2>
                <button id="level-back" class="text-xs text-slate-400 hover:text-white font-cyber uppercase">Back</button>
            </div>
            <div id="levels-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- หน้าต่างคำถาม (Quiz Container) -->
        <div id="quiz-container" class="z-50 hidden glass-panel p-10 max-w-xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <div id="quiz-level-name" class="text-[10px] font-cyber text-cyan-400 uppercase tracking-widest">Level 1</div>
                    <div id="quiz-progress-text" class="text-slate-400 text-xs">Question 1/2</div>
                </div>
                <div class="h-1 w-24 bg-slate-800 rounded-full overflow-hidden">
                    <div id="quiz-progress-bar" class="h-full bg-cyan-400 transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <h2 id="quiz-question" class="text-xl mb-8 font-semibold">Question text?</h2>
            <div id="quiz-options" class="space-y-3"></div>
        </div>

        <!-- หน้าแสดงผลลัพธ์ (Result Screen) -->
        <div id="result-screen" class="z-50 hidden glass-panel p-10 text-center max-w-sm w-full mx-4">
            <h2 id="result-title" class="text-4xl font-cyber mb-4 uppercase">Success</h2>
            <p id="result-score" class="text-slate-400 mb-8 font-cyber">Score: 0</p>
            <div class="space-y-3">
                <button id="next-btn" class="btn-cyber w-full py-3 rounded-xl font-cyber font-bold uppercase">Next Level</button>
                <button id="retry-btn" class="bg-slate-800 w-full py-3 rounded-xl font-cyber font-bold uppercase hover:bg-slate-700">Retry</button>
                <button id="result-home-btn" class="text-xs text-slate-500 hover:text-white uppercase font-cyber pt-2">Back to Menu</button>
            </div>
        </div>

        <!-- ส่วนแสดงคะแนนและพลังชีวิต (HUD) -->
        <div id="hud" class="absolute top-6 left-6 right-6 hidden flex justify-between items-center pointer-events-none">
            <div class="glass-panel px-4 py-2 border-cyan-500/50">
                <span class="text-[10px] font-cyber text-cyan-400 block uppercase">Score</span>
                <span id="hud-score" class="font-cyber text-xl">0000</span>
            </div>
            <div class="glass-panel px-4 py-2 border-rose-500/50">
                <span class="text-[10px] font-cyber text-rose-400 block uppercase">Integrity</span>
                <span id="hud-health" class="text-xl">⚡⚡⚡</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // แก้ไข: ใช้ Firebase Config ที่กำหนดไว้ (ตัวอย่างนี้ใช้ค่าเดิมที่คุณให้มา แนะนำให้ใช้ __firebase_config ในระบบจริง)
        const firebaseConfig = {
            apiKey: "AIzaSyDMUD2FqIig-OB0LKcBPneJ2VZI1Y8hEJA",
            authDomain: "electronicsadventure-eb11e.firebaseapp.com",
            projectId: "electronicsadventure-eb11e",
            storageBucket: "electronicsadventure-eb11e.firebasestorage.app",
            messagingSenderId: "110945756486",
            appId: "1:110945756486:web:91741fd3f82c707daf3147",
            measurementId: "G-9HTGX9LKDZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'electronics-adventure';

        const TEACHER_KEY = "T.rctele";
        let currentUser = null;
        let userData = { name: "", sid: "", maxLevel: 1, highScore: 0 };
        let currentLevel = 1, score = 0, health = 3, currentQIndex = 0;

        const levelData = [
            { id: 1, name: "Diode Basics", questions: [
                { q: "ไดโอดยอมให้กระแสไหลทิศทางเดียวใช่หรือไม่?", options: ["ใช่", "ไม่ใช่"], correct: 0 },
                { q: "ขา K ของไดโอดเรียกว่าอะไร?", options: ["Anode", "Cathode", "Gate"], correct: 1 }
            ]},
            { id: 2, name: "Resistor", questions: [
                { q: "สี น้ำตาล-ดำ-แดง คือค่าเท่าไหร่?", options: ["100 Ohm", "1k Ohm", "10k Ohm"], correct: 1 },
                { q: "หน่วยของความต้านทานคืออะไร?", options: ["Ampere", "Volt", "Ohm"], correct: 2 }
            ]},
            { id: 3, name: "Capacitor", questions: [
                { q: "ตัวเก็บประจุทำหน้าที่อะไร?", options: ["เก็บพลังงานในรูปสนามไฟฟ้า", "ขยายสัญญาณ", "ลดแรงดัน"], correct: 0 }
            ]}
        ];

        // ระบบ Auth
        const startNetwork = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) { 
                console.error("Auth Error:", e);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-status').innerText = "System Connected";
            }
        });

        startNetwork();

        // ฟังก์ชันอัปเดต Profile บนหน้าจอ
        function updateUIProfile() {
            document.getElementById('profile-name').innerText = userData.name;
            document.getElementById('profile-sid').innerText = userData.sid;
            document.getElementById('user-profile').classList.remove('hidden');
        }

        async function initGameAuth() {
            const nameInput = document.getElementById('input-name')?.value.trim();
            const sidInput = document.getElementById('input-sid')?.value.trim();

            if (!nameInput || !sidInput) {
                alert("กรุณากรอกข้อมูลให้ครบถ้วน");
                return;
            }

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', nameInput);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    userData = docSnap.data();
                } else {
                    userData = { 
                        name: nameInput,
                        sid: sidInput,
                        maxLevel: 1,
                        highScore: 0,
                        lastLogin: new Date().toISOString()
                    };
                }

                await setDoc(docRef, userData, { merge: true });
                
                // อัปเดต Profile และแสดงหน้าหลัก
                updateUIProfile();
                alert("เชื่อมต่อระบบสำเร็จ! ยินดีต้อนรับคุณ " + nameInput);
                showMainMenu();
            } catch (error) {
                console.error("Firebase Error:", error);
                alert("ไม่สามารถเชื่อมต่อฐานข้อมูลได้: " + error.message);
            }
        }

        document.getElementById('login-student-btn').addEventListener('click', initGameAuth);

        const showView = (id) => {
            ['auth-view', 'teacher-view', 'main-menu', 'level-selection', 'quiz-container', 'result-screen'].forEach(v => {
                document.getElementById(v).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
            
            // ซ่อน/แสดง HUD และ Profile ตามความเหมาะสม
            document.getElementById('hud').classList.toggle('hidden', !['quiz-container', 'result-screen'].includes(id));
            
            // หากอยู่ในหน้า Auth หรือ Teacher ไม่ต้องโชว์ Profile นักเรียน
            if (id === 'auth-view' || id === 'teacher-view') {
                document.getElementById('user-profile').classList.add('hidden');
            } else if (userData.name) {
                document.getElementById('user-profile').classList.remove('hidden');
            }
        };

        const showMainMenu = () => {
            showView('main-menu');
            document.getElementById('player-welcome').innerText = `READY TO START? NODE SYSTEM INITIALIZED`;
        };

        // แผงควบคุมครู
        document.getElementById('teacher-login-btn').onclick = () => {
            if (document.getElementById('input-pass').value === TEACHER_KEY) {
                showView('teacher-view');
                const studentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'students');
                onSnapshot(studentsRef, (snap) => {
                    const b = document.getElementById('teacher-table-body'); 
                    b.innerHTML = '';
                    snap.forEach(d => {
                        const data = d.data();
                        b.innerHTML += `
                            <tr class="border-b border-slate-800">
                                <td class="p-3 font-cyber text-cyan-400 text-xs">${data.sid || 'N/A'}</td>
                                <td class="p-3">${data.name || 'N/A'}</td>
                                <td class="p-3 text-center">Node ${data.maxLevel || 1}</td>
                                <td class="p-3 text-center text-yellow-400 font-cyber">${data.highScore || 0}</td>
                            </tr>`;
                    });
                }, (err) => console.error("Snapshot Error:", err));
            } else {
                alert("Teacher Secret Key ไม่ถูกต้อง");
            }
        };

        document.getElementById('tab-teacher').onclick = () => {
            document.getElementById('student-form').classList.add('hidden');
            document.getElementById('teacher-form').classList.remove('hidden');
            document.getElementById('tab-teacher').classList.add('active');
            document.getElementById('tab-student').classList.remove('active');
        };
        document.getElementById('tab-student').onclick = () => {
            document.getElementById('student-form').classList.remove('hidden');
            document.getElementById('teacher-form').classList.add('hidden');
            document.getElementById('tab-student').classList.add('active');
            document.getElementById('tab-teacher').classList.remove('active');
        };

        document.getElementById('play-btn').onclick = () => {
            showView('level-selection');
            const g = document.getElementById('levels-grid'); g.innerHTML = '';
            levelData.forEach(l => {
                const locked = l.id > userData.maxLevel;
                const div = document.createElement('div');
                div.className = `level-card glass-panel p-6 text-center ${locked ? 'locked' : ''}`;
                div.innerHTML = `
                    <div class="font-cyber text-cyan-400 mb-2">Node ${l.id}</div>
                    <div class="text-sm font-bold">${l.name}</div>
                    <div class="text-[10px] mt-2 opacity-50 font-cyber">${locked ? 'LOCKED' : 'READY'}</div>
                `;
                if (!locked) div.onclick = () => startLevel(l.id);
                g.appendChild(div);
            });
        };

        const startLevel = (id) => {
            currentLevel = id; score = 0; health = 3; currentQIndex = 0;
            showView('quiz-container'); showQuestion(); updateHUD();
        };

        const showQuestion = () => {
            const level = levelData.find(l => l.id === currentLevel);
            const q = level.questions[currentQIndex];
            document.getElementById('quiz-level-name').innerText = `Level ${currentLevel}: ${level.name}`;
            document.getElementById('quiz-progress-text').innerText = `Question ${currentQIndex + 1}/${level.questions.length}`;
            document.getElementById('quiz-progress-bar').style.width = `${((currentQIndex + 1) / level.questions.length) * 100}%`;
            document.getElementById('quiz-question').innerText = q.q;
            const o = document.getElementById('quiz-options'); o.innerHTML = '';
            q.options.forEach((opt, i) => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-4 rounded-xl border border-slate-700 hover:border-cyan-500 hover:bg-cyan-500/10 transition-all";
                b.innerText = opt;
                b.onclick = () => {
                    if (i === q.correct) score += 500; else health--;
                    updateHUD();
                    if (health <= 0) return endLevel(false);
                    currentQIndex++;
                    if (currentQIndex >= level.questions.length) endLevel(true);
                    else showQuestion();
                };
                o.appendChild(b);
            });
        };

        const updateHUD = () => {
            document.getElementById('hud-score').innerText = score.toString().padStart(4, '0');
            document.getElementById('hud-health').innerText = "⚡".repeat(health);
        };

        const endLevel = async (won) => {
            showView('result-screen');
            if (won) {
                if (currentLevel === userData.maxLevel) userData.maxLevel++;
                userData.highScore = Math.max(userData.highScore, score);
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', userData.name);
                await setDoc(docRef, userData, {merge:true});
            }
            document.getElementById('result-title').innerText = won ? "Success" : "Failed";
            document.getElementById('result-title').className = `text-4xl font-cyber mb-4 uppercase ${won ? 'text-cyan-400' : 'text-rose-500'}`;
            document.getElementById('result-score').innerText = `Points Earned: ${score}`;
            document.getElementById('next-btn').classList.toggle('hidden', !won || currentLevel >= levelData.length);
            document.getElementById('next-btn').onclick = () => startLevel(currentLevel+1);
            document.getElementById('retry-btn').onclick = () => startLevel(currentLevel);
            document.getElementById('result-home-btn').onclick = () => showMainMenu();
        };

        document.getElementById('level-back').onclick = showMainMenu;
    </script>
</body>
</html>